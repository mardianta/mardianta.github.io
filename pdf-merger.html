<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alat PDF - Gabung, Pisah & Edit</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        :root {
            --bs-primary: royalblue;
            --bs-primary-rgb: 65, 105, 225;
        }

        body {
            background-color: #f0f2f5;
        }

        .drop-area {
            border-width: 3px !important;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .drop-area.highlight {
            border-color: var(--bs-primary) !important;
            background-color: rgba(var(--bs-primary-rgb), 0.1);
        }
        
        /* Styles for PDF Editor */
        #editCanvasContainer {
            position: relative;
            border: 1px solid #ccc;
            background-color: #e9ecef;
            max-width: 100%;
            overflow: auto;
            margin: 0 auto; /* Center the container */
        }
        #editCanvas {
            cursor: text;
            display: block; /* Remove extra space below canvas */
            margin: 0 auto; /* Center the canvas */
        }
        .text-input-overlay, .image-overlay {
            position: absolute;
            border: 1px dashed #007bff;
            background-color: rgba(255, 255, 255, 0.8);
            font-family: sans-serif;
            padding: 2px;
            z-index: 10;
            resize: both; /* Allow resizing */
            overflow: hidden; /* Hide overflow when resizing */
            cursor: grab;
        }
        .text-input-overlay.selected, .image-overlay.selected {
            border: 2px solid #007bff; /* Stronger border when selected */
            box-shadow: 0 0 5px rgba(0, 123, 255, 0.5);
        }
        .text-input-overlay textarea {
            width: 100%;
            height: 100%;
            border: none;
            background: transparent;
            resize: none;
            overflow: hidden;
            font-family: inherit;
            padding: 0;
            margin: 0;
            box-sizing: border-box;
        }
        .text-options {
            margin-top: 10px;
            text-align: left;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            align-items: center;
        }
        .text-options select, .text-options input[type="color"], .text-options button {
            flex-grow: 1;
            min-width: 80px;
            max-width: 150px;
        }

        .drop-area .icon {
            font-size: 4rem;
            color: var(--bs-primary);
        }

        .file-input {
            display: none;
        }

        #mergeFileList {
            max-height: 250px;
            overflow-y: auto;
        }

        #pdfThumbnailsContainer {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            max-height: 400px;
            overflow-y: auto;
            padding: 10px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            background-color: #f8f9fa;
        }
        .pdf-thumbnail-item {
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 5px;
            text-align: center;
            background-color: #fff;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
    </style>
</head>
<body class="bg-light-subtle">
    <div class="container my-5">
        <div class="card shadow-sm">
            <div class="card-header">
                <ul class="nav nav-tabs card-header-tabs" id="pdfToolsTab" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="merger-tab" data-bs-toggle="tab" data-bs-target="#merger-tab-pane" type="button" role="tab" aria-controls="merger-tab-pane" aria-selected="true">
                            <i class="fa-solid fa-object-group me-2"></i>Gabung PDF
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="splitter-tab" data-bs-toggle="tab" data-bs-target="#splitter-tab-pane" type="button" role="tab" aria-controls="splitter-tab-pane" aria-selected="false">
                            <i class="fa-solid fa-scissors me-2"></i>Pisah PDF
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="editor-tab" data-bs-toggle="tab" data-bs-target="#editor-tab-pane" type="button" role="tab" aria-controls="editor-tab-pane" aria-selected="false">
                            <i class="fa-solid fa-pencil me-2"></i>Edit PDF (Masih Pengembangan)
                        </button>
                    </li>
                </ul>
            </div>
            <div class="tab-content" id="pdfToolsTabContent">
                <div class="tab-pane fade show active" id="merger-tab-pane" role="tabpanel" aria-labelledby="merger-tab" tabindex="0">
                    <div class="card-body p-4 p-md-5 text-center">
                        <h1 class="card-title text-primary fw-bold mb-4">Penggabung PDF Online</h1>
                        <div class="drop-area border border-dashed rounded p-5 mb-4" id="mergeDragArea">
                            <span class="icon"><i class="fa-solid fa-file-pdf"></i></span>
                            <p class="fs-5 text-muted my-2">Seret & jatuhkan file PDF di sini atau</p>
                            <button class="btn btn-primary upload-btn px-4">
                                <i class="fa-solid fa-upload me-2"></i>Pilih File
                            </button>
                            <input type="file" id="mergeFileInput" class="file-input" accept=".pdf" multiple>
                        </div>
                        <ul class="list-group text-start mb-4" id="mergeFileList"></ul>
                        <div class="d-grid gap-2 d-sm-flex justify-content-sm-center">
                            <button class="btn btn-primary btn-lg px-4" id="mergeBtn" disabled>
                                <i class="fa-solid fa-wand-magic-sparkles me-2"></i>Gabungkan PDF
                            </button>
                            <a id="mergeDownloadBtn" class="btn btn-success btn-lg px-4 d-none">
                                <i class="fa-solid fa-download me-2"></i>Unduh PDF Gabungan
                            </a>
                        </div>
                        <div class="alert mt-4 d-none" id="mergeFeedback" role="alert"></div>
                    </div>
                </div>
                <div class="tab-pane fade" id="splitter-tab-pane" role="tabpanel" aria-labelledby="splitter-tab" tabindex="0">
                    <div class="card-body p-4 p-md-5 text-center">
                        <h1 class="card-title text-primary fw-bold mb-4">Pemisah PDF Online</h1>
                        <div class="drop-area border border-dashed rounded p-5 mb-4" id="splitUploadArea">
                            <span class="icon"><i class="fa-solid fa-file-import"></i></span>
                            <p class="fs-5 text-muted my-2">Seret & jatuhkan satu file PDF di sini atau</p>
                            <button class="btn btn-primary upload-btn px-4"><i class="fa-solid fa-upload me-2"></i>Pilih File</button>
                            <input type="file" id="splitFileInput" class="file-input" accept=".pdf">
                        </div>
                        <div id="splitFileInfo" class="text-start mb-4 d-none">
                            <p><strong>File Terpilih:</strong> <span id="splitFileName" class="text-muted"></span></p>
                            <p><strong>Total Halaman:</strong> <span id="splitTotalPages" class="text-muted"></span></p>
                            <div class="mb-3">
                                <div class="form-check text-start mb-2">
                                    <input class="form-check-input" type="checkbox" id="selectAllPages">
                                    <label class="form-check-label" for="selectAllPages">
                                        Pilih Semua Halaman
                                    </label>
                                </div>
                                <p class="form-text text-start">Pilih halaman yang ingin Anda pisahkan:</p>
                                <div id="pdfThumbnailsContainer" class="mt-3 d-flex flex-wrap justify-content-center gap-3">
                                    </div>
                            </div>
                        </div>
                        <div class="d-grid gap-2 d-sm-flex justify-content-sm-center">
                            <button class="btn btn-primary btn-lg px-4" id="splitBtn" disabled>
                                <i class="fa-solid fa-scissors me-2"></i>Pisahkan PDF
                            </button>
                            <a id="splitDownloadBtn" class="btn btn-success btn-lg px-4 d-none">
                                <i class="fa-solid fa-download me-2"></i>Unduh PDF Hasil
                            </a>
                        </div>
                        <div class="alert mt-4 d-none" id="splitFeedback" role="alert"></div>
                    </div>
                </div>
                <div class="tab-pane fade" id="editor-tab-pane" role="tabpanel" aria-labelledby="editor-tab" tabindex="0">
                    <div class="card-body p-4 p-md-5 text-center">
                        <h1 class="card-title text-primary fw-bold mb-4">Editor PDF (Tambah Teks & Gambar)</h1>
                        <p class="text-muted mb-4">Fitur ini memungkinkan Anda untuk menambahkan teks dan gambar baru ke halaman PDF. Ini **tidak dapat** mengedit teks atau gambar yang sudah ada.</p>
                        
                        <div class="drop-area border border-dashed rounded p-5 mb-4" id="editUploadArea">
                            <span class="icon"><i class="fa-solid fa-file-pen"></i></span>
                            <p class="fs-5 text-muted my-2">Seret & jatuhkan file PDF di sini atau</p>
                            <button class="btn btn-primary upload-btn px-4"><i class="fa-solid fa-upload me-2"></i>Pilih File</button>
                            <input type="file" id="editFileInput" class="file-input" accept=".pdf">
                        </div>

                        <div id="editorView" class="d-none">
                            <p><strong>File:</strong> <span id="editFileName" class="text-muted"></span></p>
                            
                            <div class="text-options card p-3 mb-3">
                                <h5 class="mb-3 text-primary">Opsi Teks:</h5>
                                <div class="row g-2">
                                    <div class="col-md-3">
                                        <input type="number" id="fontSizeInput" class="form-control" value="12" min="6" max="72" step="1" aria-label="Ukuran Font">
                                        <small class="text-muted">Ukuran Font</small>
                                    </div>
                                    <div class="col-md-3">
                                        <select id="fontFamilySelect" class="form-select" aria-label="Jenis Font">
                                            <option value="Helvetica">Helvetica</option>
                                            <option value="Times-Roman">Times Roman</option>
                                            <option value="Courier">Courier</option>
                                            <option value="Arial" disabled>Arial (Tidak Didukung)</option>
                                        </select>
                                        <small class="text-muted">Jenis Font</small>
                                    </div>
                                    <div class="col-md-3">
                                        <input type="color" id="fontColorInput" class="form-control form-control-color" value="#000000" title="Warna Font">
                                        <small class="text-muted">Warna Font</small>
                                    </div>
                                    <div class="col-md-3 d-flex align-items-center">
                                        <button class="btn btn-secondary w-100" id="addTextBoxBtn">
                                            <i class="fa-solid fa-plus me-1"></i>Tambah Teks
                                        </button>
                                    </div>
                                </div>
                                <hr>
                                <h5 class="mb-3 text-primary">Opsi Gambar:</h5>
                                <div class="row g-2 align-items-center">
                                    <div class="col-md-6">
                                        <input type="file" id="imageUpload" accept="image/*" class="form-control">
                                    </div>
                                    <div class="col-md-6">
                                        <button class="btn btn-secondary w-100" id="addImageBtn" disabled>
                                            <i class="fa-solid fa-image me-1"></i>Tambahkan Gambar
                                        </button>
                                    </div>
                                </div>
                                <hr>
                                <button class="btn btn-danger btn-sm mt-2" id="deleteSelectedAnnotationBtn" disabled>
                                    <i class="fa-solid fa-trash-alt me-1"></i>Hapus yang Dipilih
                                </button>
                            </div>

                            <div id="editCanvasContainer" class="mb-3">
                                <canvas id="editCanvas"></canvas>
                                </div>
                            
                            <div class="d-flex justify-content-center align-items-center my-3">
                                <div id="editPageNav">
                                    <button class="btn btn-secondary" id="editPrevPageBtn" disabled>&lt; Sebelumnya</button>
                                    <span id="editCurrentPageSpan" class="mx-2 align-middle">Halaman 1 / 1</span>
                                    <button class="btn btn-secondary" id="editNextPageBtn" disabled>Berikutnya &gt;</button>
                                </div>
                            </div>

                            <div class="d-grid gap-2 d-sm-flex justify-content-sm-center mt-4">
                                <button class="btn btn-primary btn-lg px-4" id="editSaveBtn" disabled>
                                    <i class="fa-solid fa-save me-2"></i>Simpan & Unduh
                                </button>
                                <a id="editDownloadLink" class="btn btn-success btn-lg px-4 d-none">
                                    <i class="fa-solid fa-download me-2"></i>Unduh PDF yang Diedit
                                </a>
                            </div>
                        </div>
                        <div class="alert mt-4 d-none" id="editFeedback" role="alert"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="card shadow-sm mt-4">
            <div class="d-flex flex-column flex-md-row">
                <div class="card-body p-4 p-md-5 flex-grow-1">
                    <h2 class="card-title text-primary mb-3">Tentang Alat Penggabung PDF Ini</h2>
                    <p class="card-text"><strong>Penggabung PDF Online</strong> ini adalah alat berbasis web yang memungkinkan Anda untuk menggabungkan beberapa file PDF menjadi satu dokumen tunggal dengan mudah dan cepat. Semua proses penggabungan dilakukan langsung di browser Anda, tanpa perlu mengunggah file ke server.</p>
                    
                    <h3 class="text-primary mt-4 mb-3">Bagaimana Cara Kerjanya?</h3>
                    <p class="card-text">Alat ini menggunakan pustaka JavaScript yang kuat bernama <strong>pdf-lib</strong>. Ketika Anda memilih file PDF, browser Anda akan membaca file tersebut, dan pustaka ini akan memprosesnya untuk menyalin halaman dari setiap dokumen dan menyusunnya menjadi satu file PDF baru. Karena semua proses terjadi di sisi klien (di komputer Anda), file Anda tetap aman dan pribadi.</p>

                    <h3 class="text-primary mt-4 mb-3">Keuntungan Utama</h3>
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item"><i class="fa-solid fa-lock me-2 text-success"></i><strong>Privasi Terjamin:</strong> File Anda tidak pernah meninggalkan komputer Anda. Tidak ada data yang dikirim atau disimpan di server eksternal.</li>
                        <li class="list-group-item"><i class="fa-solid fa-bolt me-2 text-warning"></i><strong>Cepat dan Efisien:</strong> Proses penggabungan sangat cepat karena tidak ada waktu tunggu untuk unggah atau unduh dari server.</li>
                        <li class="list-group-item"><i class="fa-solid fa-infinity me-2 text-info"></i><strong>Gratis dan Tanpa Batas:</strong> Gunakan alat ini sepuasnya tanpa biaya atau batasan jumlah file.</li>
                    </ul>

                    <div class="alert alert-warning mt-4" role="alert">
                        <h4 class="alert-heading"><i class="fa-solid fa-triangle-exclamation me-2"></i>Peringatan</h4>
                        <p>Meskipun alat ini efisien, menggabungkan file PDF yang sangat besar atau dalam jumlah yang sangat banyak dapat membebani memori browser Anda dan mungkin menyebabkan kinerja lambat atau crash pada browser. Disarankan untuk me-refresh halaman jika Anda mengalami masalah.</p>
                    </div>
                </div>
                <div class="p-4 text-center d-flex flex-column align-items-center" style="max-width: 200px;">
                    <img src="qr.jpeg" alt="QR Code Donasi" class="img-fluid">
                    <p class="text-muted mt-2">Pindai Kode QR ini untuk berdonasi dan mendukung pengembangan alat ini.</p>
                    <a href="qris://qr/api/show?data=00020101021126690021ID.CO.BANKMANDIRI.WWW01189360000801821698940211718216989450303UMI51440014ID.CO.QRIS.WWW0215ID10254132220070303UMI5204274153033605802ID5913Mardianta Pay6015Surabaya (Kota)61056013262070703A0163041348" class="btn btn-info btn-sm mt-2 w-100">
                        <i class="fa-solid fa-qrcode me-1"></i> Bayar dengan QRIS
                    </a>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        document.addEventListener('DOMContentLoaded', () => {
            const { PDFDocument, rgb, StandardFonts } = PDFLib;

            // --- MERGER SCRIPT ---
            const mergeDragArea = document.getElementById('mergeDragArea');
            const mergeFileInput = document.getElementById('mergeFileInput');
            const mergeFileList = document.getElementById('mergeFileList');
            const mergeBtn = document.getElementById('mergeBtn');
            const mergeDownloadBtn = document.getElementById('mergeDownloadBtn');
            const mergeFeedback = document.getElementById('mergeFeedback');

            let uploadedFiles = [];

            function showMergeFeedback(message, type) {
                mergeFeedback.textContent = message;
                mergeFeedback.className = `alert alert-${type} d-block`;
            }

            function hideMergeFeedback() {
                mergeFeedback.className = 'alert d-none';
            }

            function updateMergeFileList() {
                mergeFileList.innerHTML = '';
                if (uploadedFiles.length === 0) {
                    mergeFileList.classList.add('d-none');
                    mergeBtn.disabled = true;
                    mergeDownloadBtn.classList.add('d-none');
                    return;
                }

                mergeFileList.classList.remove('d-none');
                uploadedFiles.forEach((file, index) => {
                    const listItem = document.createElement('div');
                    listItem.className = 'list-group-item d-flex justify-content-between align-items-center';
                    listItem.innerHTML = `
                        <span class="text-truncate me-3">${file.name}</span>
                        <button class="btn btn-sm btn-outline-danger remove-btn" data-index="${index}">&times;</button>
                    `;
                    mergeFileList.appendChild(listItem);
                });

                mergeBtn.disabled = false;
            }

            function handleMergeFiles(files) {
                const pdfs = files.filter(file => file.type === 'application/pdf');
                if (pdfs.length === 0) {
                    showMergeFeedback('Hanya file PDF yang diizinkan.', 'danger');
                    return;
                }
                pdfs.forEach(newFile => {
                    const exists = uploadedFiles.some(existingFile => existingFile.name === newFile.name && existingFile.size === newFile.size);
                    if (!exists) {
                        uploadedFiles.push(newFile);
                    } else {
                        showMergeFeedback(`File "${newFile.name}" sudah ada dalam daftar.`, 'warning');
                    }
                });
                updateMergeFileList();
            }

            mergeDragArea.querySelector('.upload-btn').addEventListener('click', () => mergeFileInput.click());
            mergeFileInput.addEventListener('change', (event) => {
                hideMergeFeedback();
                handleMergeFiles(Array.from(event.target.files));
            });

            mergeDragArea.addEventListener('dragover', (event) => {
                event.preventDefault();
                mergeDragArea.classList.add('highlight');
            });
            mergeDragArea.addEventListener('dragleave', () => mergeDragArea.classList.remove('highlight'));
            mergeDragArea.addEventListener('drop', (event) => {
                event.preventDefault();
                mergeDragArea.classList.remove('highlight');
                hideMergeFeedback();
                handleMergeFiles(Array.from(event.dataTransfer.files));
            });

            mergeFileList.addEventListener('click', (event) => {
                if (event.target.classList.contains('remove-btn')) {
                    const indexToRemove = parseInt(event.target.dataset.index);
                    uploadedFiles.splice(indexToRemove, 1);
                    updateMergeFileList();
                    hideMergeFeedback();
                }
            });

            mergeBtn.addEventListener('click', async () => {
                if (uploadedFiles.length < 2) {
                    showMergeFeedback('Pilih setidaknya 2 file PDF untuk digabungkan.', 'danger');
                    return;
                }
                showMergeFeedback('Menggabungkan PDF, mohon tunggu...', 'info');
                mergeBtn.disabled = true;
                mergeDownloadBtn.classList.add('d-none');
                try {
                    const mergedPdf = await PDFDocument.create();
                    for (const file of uploadedFiles) {
                        const arrayBuffer = await file.arrayBuffer();
                        const pdf = await PDFDocument.load(arrayBuffer);
                        const copiedPages = await mergedPdf.copyPages(pdf, pdf.getPageIndices());
                        copiedPages.forEach((page) => mergedPdf.addPage(page));
                    }
                    const mergedPdfBytes = await mergedPdf.save();
                    const blob = new Blob([mergedPdfBytes], { type: 'application/pdf' });
                    const url = URL.createObjectURL(blob);
                    mergeDownloadBtn.href = url;
                    mergeDownloadBtn.download = 'pdf_gabungan.pdf';
                    mergeDownloadBtn.classList.remove('d-none');
                    showMergeFeedback('PDF berhasil digabungkan!', 'success');
                } catch (error) {
                    console.error('Error saat menggabungkan PDF:', error);
                    showMergeFeedback(`Terjadi kesalahan saat menggabungkan PDF: ${error.message}`, 'danger');
                } finally {
                    mergeBtn.disabled = false;
                }
            });
            updateMergeFileList();

            // --- SPLITTER SCRIPT ---
            const splitUploadArea = document.getElementById('splitUploadArea');
            const splitFileInput = document.getElementById('splitFileInput');
            const splitFileInfoDiv = document.getElementById('splitFileInfo');
            const splitFileNameSpan = document.getElementById('splitFileName');
            const splitTotalPagesSpan = document.getElementById('splitTotalPages');
            const selectAllPagesCheckbox = document.getElementById('selectAllPages');
            const pdfThumbnailsContainer = document.getElementById('pdfThumbnailsContainer');
            const splitBtn = document.getElementById('splitBtn');
            const splitDownloadBtn = document.getElementById('splitDownloadBtn');
            const splitFeedback = document.getElementById('splitFeedback');

            let splitUploadedFile = null;
            let splitSourcePdfDoc = null;
            let splitPdfjsDoc = null; // To store PDF.js document for rendering

            function showSplitFeedback(message, type) {
                splitFeedback.textContent = message;
                splitFeedback.className = `alert alert-${type} d-block`;
            }

            function hideSplitFeedback() {
                splitFeedback.className = 'alert d-none';
            }

            async function renderPdfThumbnails(pdfDoc) {
                pdfThumbnailsContainer.innerHTML = ''; // Clear previous thumbnails
                for (let i = 1; i <= pdfDoc.numPages; i++) {
                    const page = await pdfDoc.getPage(i);
                    const viewport = page.getViewport({ scale: 0.5 }); // Adjust scale for thumbnail size

                    const canvas = document.createElement('canvas');
                    const context = canvas.getContext('2d');
                    canvas.height = viewport.height;
                    canvas.width = viewport.width;

                    const renderContext = {
                        canvasContext: context,
                        viewport: viewport,
                    };
                    await page.render(renderContext).promise;

                    const thumbnailItem = document.createElement('div');
                    thumbnailItem.className = 'pdf-thumbnail-item';
                    thumbnailItem.innerHTML = `
                        <div class="form-check">
                            <input class="form-check-input page-checkbox" type="checkbox" value="${i - 1}" id="pageCheck${i}" checked>
                            <label class="form-check-label" for="pageCheck${i}">
                                Halaman ${i}
                            </label>
                        </div>
                    `;
                    thumbnailItem.appendChild(canvas);
                    pdfThumbnailsContainer.appendChild(thumbnailItem);
                }
                selectAllPagesCheckbox.checked = true; // Select all by default
            }

            async function handleSplitFile(file) {
                if (!file || file.type !== 'application/pdf') {
                    showSplitFeedback('Silakan pilih satu file PDF.', 'danger');
                    return;
                }
                splitUploadedFile = file;
                hideSplitFeedback();
                showSplitFeedback('Memproses file...', 'info');
                try {
                    const arrayBuffer = await file.arrayBuffer();
                    splitSourcePdfDoc = await PDFDocument.load(arrayBuffer);
                    splitPdfjsDoc = await pdfjsLib.getDocument({data: arrayBuffer}).promise; // Load with PDF.js

                    splitFileNameSpan.textContent = file.name;
                    splitTotalPagesSpan.textContent = splitPdfjsDoc.numPages;
                    splitFileInfoDiv.classList.remove('d-none');
                    splitBtn.disabled = false;
                    hideSplitFeedback();

                    await renderPdfThumbnails(splitPdfjsDoc); // Render thumbnails
                } catch (error) {
                    showSplitFeedback('Gagal memuat file PDF. File mungkin rusak.', 'danger');
                    console.error(error);
                }
            }

            // Select All Pages checkbox logic
            selectAllPagesCheckbox.addEventListener('change', (event) => {
                document.querySelectorAll('.page-checkbox').forEach(checkbox => {
                    checkbox.checked = event.target.checked;
                });
            });

            splitUploadArea.querySelector('.upload-btn').addEventListener('click', () => splitFileInput.click());
            splitFileInput.addEventListener('change', (event) => handleSplitFile(event.target.files[0]));

            splitUploadArea.addEventListener('dragover', (e) => { e.preventDefault(); splitUploadArea.classList.add('highlight'); });
            splitUploadArea.addEventListener('dragleave', () => splitUploadArea.classList.remove('highlight'));
            splitUploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                splitUploadArea.classList.remove('highlight');
                handleSplitFile(e.dataTransfer.files[0]);
            });

            splitBtn.addEventListener('click', async () => {
                if (!splitSourcePdfDoc) {
                    showSplitFeedback('Silakan unggah file PDF terlebih dahulu.', 'danger');
                    return;
                }

                const selectedPageIndices = Array.from(document.querySelectorAll('.page-checkbox:checked'))
                                                .map(checkbox => parseInt(checkbox.value, 10));

                if (selectedPageIndices.length === 0) {
                    showSplitFeedback('Silakan pilih setidaknya satu halaman untuk dipisah.', 'danger');
                    return; 
                }
                showSplitFeedback('Memisahkan PDF, mohon tunggu...', 'info');
                splitBtn.disabled = true;
                splitDownloadBtn.classList.add('d-none');
                try {
                    const newPdfDoc = await PDFDocument.create();
                    const copiedPages = await newPdfDoc.copyPages(splitSourcePdfDoc, selectedPageIndices);
                    copiedPages.forEach(page => newPdfDoc.addPage(page));
                    const newPdfBytes = await newPdfDoc.save();
                    const blob = new Blob([newPdfBytes], { type: 'application/pdf' });
                    const url = URL.createObjectURL(blob);
                    splitDownloadBtn.href = url;
                    splitDownloadBtn.download = `${splitUploadedFile.name.replace('.pdf', '')}_split.pdf`;
                    splitDownloadBtn.classList.remove('d-none');
                    showSplitFeedback('PDF berhasil dipisah!', 'success');
                } catch (error) {
                    console.error('Error saat memisahkan PDF:', error);
                    showSplitFeedback(`Terjadi kesalahan: ${error.message}`, 'danger');
                } finally {
                    splitBtn.disabled = false;
                }
            });

            // --- EDIT SCRIPT ---
            const editUploadArea = document.getElementById('editUploadArea');
            const editFileInput = document.getElementById('editFileInput');
            const editorView = document.getElementById('editorView');
            const editFileNameSpan = document.getElementById('editFileName');
            const editCanvasContainer = document.getElementById('editCanvasContainer');
            const editCanvas = document.getElementById('editCanvas');
            const editPrevPageBtn = document.getElementById('editPrevPageBtn');
            const editNextPageBtn = document.getElementById('editNextPageBtn');
            const editCurrentPageSpan = document.getElementById('editCurrentPageSpan');
            const editSaveBtn = document.getElementById('editSaveBtn');
            const editDownloadLink = document.getElementById('editDownloadLink');
            const editFeedback = document.getElementById('editFeedback');
            const addTextBoxBtn = document.getElementById('addTextBoxBtn');
            const fontSizeInput = document.getElementById('fontSizeInput');
            const fontFamilySelect = document.getElementById('fontFamilySelect');
            const fontColorInput = document.getElementById('fontColorInput');
            const imageUpload = document.getElementById('imageUpload');
            const addImageBtn = document.getElementById('addImageBtn');
            const deleteSelectedAnnotationBtn = document.getElementById('deleteSelectedAnnotationBtn');


            let editPdfJsDoc = null; // PDF.js document for rendering
            let editPdfLibDoc = null; // pdf-lib document for modification
            let editCurrentPageNum = 1;
            // Store annotations (text, images) per page
            // Structure: { pageNum: [{ type: 'text', x, y, text, fontSize, fontColor, fontFamily, width, height, id }, { type: 'image', x, y, width, height, imageDataUrl, id }] }
            let editAnnotations = {}; 
            let selectedAnnotation = null; // Reference to the currently selected overlay element
            let selectedAnnotationId = null; // ID of the currently selected annotation in editAnnotations

            let isDraggingAnnotation = false;
            let isResizingAnnotation = false;
            let initialMouseX, initialMouseY;
            let initialAnnotationX, initialAnnotationY;
            let initialAnnotationWidth, initialAnnotationHeight;

            // Helper to convert hex color to RGB for pdf-lib
            function hexToRgb(hex) {
                const r = parseInt(hex.slice(1, 3), 16) / 255;
                const g = parseInt(hex.slice(3, 5), 16) / 255;
                const b = parseInt(hex.slice(5, 7), 16) / 255;
                return rgb(r, g, b);
            }

            function showEditFeedback(message, type) {
                editFeedback.textContent = message;
                editFeedback.className = `alert alert-${type} d-block`;
                if (type === 'success' || type === 'danger') {
                    setTimeout(hideEditFeedback, 3000);
                }
            }

            function hideEditFeedback() {
                editFeedback.className = 'alert d-none';
            }

            // Function to deselect any active annotation
            function deselectAnnotation() {
                if (selectedAnnotation) {
                    selectedAnnotation.classList.remove('selected');
                }
                selectedAnnotation = null;
                selectedAnnotationId = null;
                deleteSelectedAnnotationBtn.disabled = true; // Disable delete button
            }

            // Function to select an annotation
            function selectAnnotation(annotationId, overlayElement) {
                deselectAnnotation(); // Deselect any existing selection
                selectedAnnotation = overlayElement;
                selectedAnnotationId = annotationId;
                selectedAnnotation.classList.add('selected');
                deleteSelectedAnnotationBtn.disabled = false; // Enable delete button
            }

            function getAnnotationById(id) {
                const annotationsOnPage = editAnnotations[editCurrentPageNum] || [];
                return annotationsOnPage.find(anno => anno.id === id);
            }

            async function renderEditPage(pageNum) {
                if (!editPdfJsDoc) return;

                // Remove existing overlays
                Array.from(editCanvasContainer.querySelectorAll('.text-input-overlay, .image-overlay')).forEach(el => el.remove());
                deselectAnnotation(); // Deselect any annotation when changing pages

                editCurrentPageNum = pageNum;
                const page = await editPdfJsDoc.getPage(pageNum);
                const viewport = page.getViewport({ scale: 1.5 }); // Use a higher scale for better editing resolution
                const context = editCanvas.getContext('2d');

                // Adjust canvas size to match viewport and container
                editCanvas.height = viewport.height;
                editCanvas.width = viewport.width;
                editCanvasContainer.style.width = `${viewport.width}px`;
                editCanvasContainer.style.height = `${viewport.height}px`;

                // Render PDF page
                await page.render({ canvasContext: context, viewport: viewport }).promise;

                // Render existing annotations as interactive overlays
                const annotationsOnPage = editAnnotations[pageNum] || [];
                annotationsOnPage.forEach((anno) => {
                    if (anno.type === 'text') {
                        const textBox = document.createElement('div');
                        textBox.className = 'text-input-overlay';
                        textBox.style.left = `${anno.x}px`;
                        textBox.style.top = `${anno.y}px`;
                        textBox.style.width = `${anno.width}px`;
                        textBox.style.height = `${anno.height}px`;
                        textBox.dataset.annotationId = anno.id;

                        const textarea = document.createElement('textarea');
                        textarea.value = anno.text;
                        textarea.style.fontSize = `${anno.fontSize}px`;
                        textarea.style.fontFamily = anno.fontFamily;
                        textarea.style.color = anno.fontColor;
                        textarea.style.lineHeight = '1'; // Ensures text fits within height
                        textarea.addEventListener('input', (e) => {
                            anno.text = e.target.value;
                            // Optionally update width/height based on content, or let user resize
                        });
                        textarea.addEventListener('blur', () => {
                            // Trim the text and update if needed
                            anno.text = textarea.value.trim();
                            if (!anno.text) { // Remove if empty
                                deleteAnnotation(anno.id);
                            }
                            renderEditPage(editCurrentPageNum); // Re-render to clear empty box if deleted
                        });
                        textBox.appendChild(textarea);
                        editCanvasContainer.appendChild(textBox);
                        setupDraggableResizable(textBox, anno);
                    } else if (anno.type === 'image') {
                        const imageOverlay = document.createElement('div');
                        imageOverlay.className = 'image-overlay';
                        imageOverlay.style.left = `${anno.x}px`;
                        imageOverlay.style.top = `${anno.y}px`;
                        imageOverlay.style.width = `${anno.width}px`;
                        imageOverlay.style.height = `${anno.height}px`;
                        imageOverlay.dataset.annotationId = anno.id;

                        const imgElement = document.createElement('img');
                        imgElement.src = anno.imageDataUrl;
                        imgElement.style.width = '100%';
                        imgElement.style.height = '100%';
                        imgElement.style.objectFit = 'contain'; // Ensure image fits without distortion
                        imageOverlay.appendChild(imgElement);
                        editCanvasContainer.appendChild(imageOverlay);
                        setupDraggableResizable(imageOverlay, anno);
                    }
                });

                editCurrentPageSpan.textContent = `Halaman ${pageNum} / ${editPdfJsDoc.numPages}`;
                editPrevPageBtn.disabled = pageNum === 1;
                editNextPageBtn.disabled = pageNum === editPdfJsDoc.numPages;
                editSaveBtn.disabled = false; // Enable save button when a PDF is loaded and rendered
            }

            function setupDraggableResizable(element, annotation) {
                let startX, startY;
                let initialX, initialY, initialWidth, initialHeight;
                let isDragging = false;
                let isResizing = false;
                const minSize = 20; // Minimum size for annotations

                element.addEventListener('mousedown', (e) => {
                    // Check if click is on resize handle (bottom-right corner)
                    const rect = element.getBoundingClientRect();
                    const isNearRight = Math.abs(e.clientX - rect.right) < 10; // 10px tolerance
                    const isNearBottom = Math.abs(e.clientY - rect.bottom) < 10; // 10px tolerance

                    if (e.target !== element && e.target.tagName !== 'TEXTAREA' && e.target.tagName !== 'IMG') {
                        // If click is on a child element (like textarea or img), don't start drag/resize on parent
                        // Unless it's explicitly the resize area
                        return;
                    }

                    if (isNearRight && isNearBottom) {
                        isResizing = true;
                        element.style.cursor = 'nwse-resize';
                    } else {
                        isDragging = true;
                        element.style.cursor = 'grabbing';
                    }

                    initialX = element.offsetLeft;
                    initialY = element.offsetTop;
                    initialWidth = element.offsetWidth;
                    initialHeight = element.offsetHeight;
                    startX = e.clientX;
                    startY = e.clientY;

                    selectAnnotation(annotation.id, element);
                    e.preventDefault(); // Prevent default drag behavior
                });

                document.addEventListener('mousemove', (e) => {
                    if (isDragging) {
                        const dx = e.clientX - startX;
                        const dy = e.clientY - startY;
                        element.style.left = `${initialX + dx}px`;
                        element.style.top = `${initialY + dy}px`;
                        annotation.x = initialX + dx;
                        annotation.y = initialY + dy;
                        e.preventDefault();
                    } else if (isResizing) {
                        const dx = e.clientX - startX;
                        const dy = e.clientY - startY;

                        let newWidth = initialWidth + dx;
                        let newHeight = initialHeight + dy;

                        if (newWidth < minSize) newWidth = minSize;
                        if (newHeight < minSize) newHeight = minSize;

                        element.style.width = `${newWidth}px`;
                        element.style.height = `${newHeight}px`;
                        annotation.width = newWidth;
                        annotation.height = newHeight;
                        e.preventDefault();
                    }
                });

                document.addEventListener('mouseup', () => {
                    if (isDragging || isResizing) {
                        isDragging = false;
                        isResizing = false;
                        element.style.cursor = 'grab'; // Reset cursor
                    }
                });

                // Handle clicking outside to deselect
                editCanvasContainer.addEventListener('click', (e) => {
                    if (!element.contains(e.target) && selectedAnnotation === element) {
                        deselectAnnotation();
                    }
                });
            }

            function generateUniqueId() {
                return 'anno_' + Date.now() + Math.random().toString(16).slice(2);
            }

            async function handleEditFile(file) {
                if (!file || file.type !== 'application/pdf') {
                    showEditFeedback('Silakan pilih satu file PDF.', 'danger');
                    return;
                }
                hideEditFeedback();
                showEditFeedback('Memuat PDF untuk pengeditan...', 'info');
                try {
                    const arrayBuffer = await file.arrayBuffer();
                    editPdfLibDoc = await PDFDocument.load(arrayBuffer);
                    editPdfJsDoc = await pdfjsLib.getDocument({data: arrayBuffer}).promise;

                    // Initialize annotations for all pages
                    editAnnotations = {};
                    for (let i = 1; i <= editPdfJsDoc.numPages; i++) {
                        editAnnotations[i] = [];
                    }

                    editFileNameSpan.textContent = file.name;
                    editorView.classList.remove('d-none');
                    editDownloadLink.classList.add('d-none'); // Hide download link until saved
                    
                    await renderEditPage(1); // Render first page
                    showEditFeedback('PDF berhasil dimuat. Klik di mana saja untuk menambahkan teks atau gunakan tombol.', 'success');
                } catch (error) {
                    showEditFeedback('Gagal memuat file PDF. File mungkin rusak atau tidak didukung.', 'danger');
                    console.error('Error loading PDF for editing:', error);
                    editorView.classList.add('d-none'); // Hide editor if load fails
                    editPdfJsDoc = null;
                    editPdfLibDoc = null;
                }
            }

            // --- Event Listeners for Editor ---
            editUploadArea.querySelector('.upload-btn').addEventListener('click', () => editFileInput.click());
            editFileInput.addEventListener('change', (event) => handleEditFile(event.target.files[0]));
            editUploadArea.addEventListener('dragover', (e) => { e.preventDefault(); editUploadArea.classList.add('highlight'); });
            editUploadArea.addEventListener('dragleave', () => editUploadArea.classList.remove('highlight'));
            editUploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                editUploadArea.classList.remove('highlight');
                handleEditFile(e.dataTransfer.files[0]);
            });

            editPrevPageBtn.addEventListener('click', () => {
                if (editCurrentPageNum > 1) {
                    renderEditPage(editCurrentPageNum - 1);
                }
            });

            editNextPageBtn.addEventListener('click', () => {
                if (editCurrentPageNum < editPdfJsDoc.numPages) {
                    renderEditPage(editCurrentPageNum + 1);
                }
            });

            // Add Text Box
            addTextBoxBtn.addEventListener('click', () => {
                if (!editPdfJsDoc) {
                    showEditFeedback('Silakan unggah PDF terlebih dahulu.', 'warning');
                    return;
                }
                const newId = generateUniqueId();
                const newTextAnnotation = {
                    id: newId,
                    type: 'text',
                    text: 'Ketik teks di sini...',
                    x: 50, // Default position
                    y: 50,
                    width: 200,
                    height: 50,
                    fontSize: parseInt(fontSizeInput.value, 10),
                    fontFamily: fontFamilySelect.value,
                    fontColor: fontColorInput.value
                };
                if (!editAnnotations[editCurrentPageNum]) {
                    editAnnotations[editCurrentPageNum] = [];
                }
                editAnnotations[editCurrentPageNum].push(newTextAnnotation);
                renderEditPage(editCurrentPageNum); // Re-render to show new textbox
                showEditFeedback('Kotak teks baru ditambahkan.', 'info');
            });

            // Add Image
            imageUpload.addEventListener('change', async (e) => {
                addImageBtn.disabled = !e.target.files.length || !editPdfJsDoc;
            });

            addImageBtn.addEventListener('click', async () => {
                if (!editPdfJsDoc) {
                    showEditFeedback('Silakan unggah PDF terlebih dahulu.', 'warning');
                    return;
                }
                const file = imageUpload.files[0];
                if (!file) {
                    showEditFeedback('Pilih gambar untuk ditambahkan.', 'warning');
                    return;
                }

                showEditFeedback('Menambahkan gambar...', 'info');
                try {
                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        const imageDataUrl = e.target.result;
                        const img = new Image();
                        img.src = imageDataUrl;
                        await new Promise(resolve => img.onload = resolve); // Ensure image is loaded to get dimensions

                        const newId = generateUniqueId();
                        const newImageAnnotation = {
                            id: newId,
                            type: 'image',
                            imageDataUrl: imageDataUrl,
                            x: 50, // Default position
                            y: 150,
                            width: img.width > 200 ? 200 : img.width, // Limit initial width
                            height: img.height > 200 ? 200 : img.height, // Limit initial height
                        };

                        if (!editAnnotations[editCurrentPageNum]) {
                            editAnnotations[editCurrentPageNum] = [];
                        }
                        editAnnotations[editCurrentPageNum].push(newImageAnnotation);
                        renderEditPage(editCurrentPageNum);
                        showEditFeedback('Gambar berhasil ditambahkan.', 'success');
                        imageUpload.value = ''; // Clear file input
                        addImageBtn.disabled = true;
                    };
                    reader.readAsDataURL(file);
                } catch (error) {
                    showEditFeedback('Gagal menambahkan gambar.', 'danger');
                    console.error('Error adding image:', error);
                }
            });

            // Delete Selected Annotation
            deleteSelectedAnnotationBtn.addEventListener('click', () => {
                if (selectedAnnotationId) {
                    deleteAnnotation(selectedAnnotationId);
                } else {
                    showEditFeedback('Tidak ada yang dipilih untuk dihapus.', 'warning');
                }
            });

            function deleteAnnotation(idToDelete) {
                if (editAnnotations[editCurrentPageNum]) {
                    editAnnotations[editCurrentPageNum] = editAnnotations[editCurrentPageNum].filter(
                        (anno) => anno.id !== idToDelete
                    );
                    showEditFeedback('Item dihapus.', 'success');
                    renderEditPage(editCurrentPageNum); // Re-render page to reflect deletion
                }
            }


            editSaveBtn.addEventListener('click', async () => {
                if (!editPdfLibDoc) {
                    showEditFeedback('Tidak ada PDF yang dimuat untuk disimpan.', 'danger');
                    return;
                }
                showEditFeedback('Menyimpan perubahan dan mengunduh PDF...', 'info');
                editSaveBtn.disabled = true;
                editDownloadLink.classList.add('d-none');

                try {
                    const fontCache = {}; // Cache loaded fonts

                    for (const pageNum in editAnnotations) {
                        const annotationsOnPage = editAnnotations[pageNum];
                        if (annotationsOnPage.length === 0) continue;

                        const pageIndex = parseInt(pageNum, 10) - 1; // PDF-LIB pages are 0-indexed
                        if (pageIndex < 0 || pageIndex >= editPdfLibDoc.getPages().length) {
                            console.warn(`Page ${pageNum} not found in PDFLib document.`);
                            continue;
                        }
                        const pdfPage = editPdfLibDoc.getPages()[pageIndex];

                        for (const anno of annotationsOnPage) {
                            if (anno.type === 'text') {
                                let font;
                                if (fontCache[anno.fontFamily]) {
                                    font = fontCache[anno.fontFamily];
                                } else {
                                    try {
                                        font = await editPdfLibDoc.embedFont(StandardFonts[anno.fontFamily]);
                                        fontCache[anno.fontFamily] = font;
                                    } catch (e) {
                                        console.warn(`Font ${anno.fontFamily} not supported by pdf-lib. Using Helvetica.`, e);
                                        font = await editPdfLibDoc.embedFont(StandardFonts.Helvetica);
                                        fontCache.Helvetica = font;
                                    }
                                }

                                const rgbColor = hexToRgb(anno.fontColor);
                                
                                // Calculate position relative to PDF page (PDF-LIB uses bottom-left origin)
                                // Y coordinate needs to be inverted: canvasY = pageHeight - pdfY - textHeight
                                const textHeight = anno.fontSize; // Approximation, font metrics would be better
                                const pdfY = pdfPage.getHeight() - anno.y - textHeight;

                                pdfPage.drawText(anno.text, {
                                    x: anno.x,
                                    y: pdfY,
                                    font,
                                    size: anno.fontSize,
                                    color: rgbColor,
                                    lineHeight: anno.fontSize * 1.2, // Adjust line height for multi-line text if needed
                                    maxWidth: anno.width,
                                    // wordBreaks: [' '], // To enable word wrapping
                                });
                            } else if (anno.type === 'image') {
                                const imageBytes = await fetch(anno.imageDataUrl).then(res => res.arrayBuffer());
                                let pdfImage;
                                if (anno.imageDataUrl.startsWith('data:image/jpeg')) {
                                    pdfImage = await editPdfLibDoc.embedJpg(imageBytes);
                                } else if (anno.imageDataUrl.startsWith('data:image/png')) {
                                    pdfImage = await editPdfLibDoc.embedPng(imageBytes);
                                } else {
                                    console.warn('Unsupported image format for embedding:', anno.imageDataUrl);
                                    continue;
                                }
                                
                                // Y coordinate needs to be inverted for images too
                                const pdfY = pdfPage.getHeight() - anno.y - anno.height;

                                pdfPage.drawImage(pdfImage, {
                                    x: anno.x,
                                    y: pdfY,
                                    width: anno.width,
                                    height: anno.height,
                                });
                            }
                        }
                    }

                    const modifiedPdfBytes = await editPdfLibDoc.save();
                    const blob = new Blob([modifiedPdfBytes], { type: 'application/pdf' });
                    const url = URL.createObjectURL(blob);

                    editDownloadLink.href = url;
                    editDownloadLink.download = `${editFileNameSpan.textContent.replace('.pdf', '')}_edited.pdf`;
                    editDownloadLink.classList.remove('d-none');
                    showEditFeedback('PDF berhasil diedit dan siap diunduh!', 'success');

                } catch (error) {
                    console.error('Error saving edited PDF:', error);
                    showEditFeedback(`Terjadi kesalahan saat menyimpan PDF: ${error.message}`, 'danger');
                } finally {
                    editSaveBtn.disabled = false;
                }
            });
        });
    </script>
</body>
</html>