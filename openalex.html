<!DOCTYPE html>
<html lang="id" data-bs-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Publikasi Universitas</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

    <style>
        :root {
            --primary-color: #4169E1; /* Royal Blue */
            --primary-dark: #375bb9;
            --secondary-color: #6c757d;
            --background-color: #f0f2f5;
            --panel-bg: #ffffff;
            --text-color: #212529;
            --border-color: #e9ecef;
            --card-hover-shadow: rgba(0,0,0,0.08);
            --info-bg: #e9ecef;
        }

        [data-bs-theme="dark"] {
            --primary-color: #6a8ce1; /* Royal Blue yang lebih terang untuk tema gelap */
            --primary-dark: #5171c7;
            --secondary-color: #adb5bd;
            --background-color: #121212;
            --panel-bg: #1e1e1e;
            --text-color: #f8f9fa;
            --border-color: #343a40;
            --card-hover-shadow: rgba(255,255,255,0.08);
            --info-bg: #343a40;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
        }

        .container {
            max-width: 1300px;
        }

        .navbar {
            background-color: var(--panel-bg);
            border-bottom: 1px solid var(--border-color);
        }
        .navbar-brand {
            font-weight: 700;
            font-size: 1.5rem;
            color: var(--primary-color) !important;
        }

        .panel {
            background-color: var(--panel-bg);
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.06);
            margin-bottom: 25px;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }
        .panel:hover {
            box-shadow: 0 6px 18px var(--card-hover-shadow);
        }

        .chart-container {
            position: relative;
            height: 60vh;
        }

        #loading-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 10;
        }

        .table-sm th, .table-sm td {
            padding: 0.6rem;
            vertical-align: middle;
        }

        .table-hover tbody tr:hover {
            background-color: var(--border-color);
        }

        .chart-title {
            text-align: center;
            margin-bottom: 1.5rem;
            font-size: 1.5rem;
            color: var(--primary-color);
        }

        .icon-small {
            font-size: 1.1rem;
            margin-right: 8px;
            vertical-align: middle;
        }
        
        .footer-app-info {
            background-color: var(--info-bg);
            color: var(--text-color);
            padding: 20px;
            border-radius: 8px;
            margin-top: 30px;
            text-align: center;
        }

        .footer-app-info h4 {
            margin-bottom: 10px;
            color: var(--primary-color);
        }
        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        .btn-primary:hover {
            background-color: var(--primary-dark);
            border-color: var(--primary-dark);
        }
        .text-primary {
            color: var(--primary-color) !important;
        }
    </style>
</head>
<body>
    
    <nav class="navbar navbar-expand-lg sticky-top">
        <div class="container">
            <a class="navbar-brand" href="#"><i class="bi bi-bar-chart-line-fill me-2"></i>Dashboard Publikasi</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <button class="btn btn-outline-secondary" id="theme-toggle-btn">
                            <i class="bi bi-sun-fill" id="theme-icon"></i>
                        </button>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <h1 class="text-center mb-4 pb-2 border-bottom">Analisis Perbandingan Publikasi Ilmiah</h1>

        <div class="panel" id="filter-panel">
            <h4 class="mb-4"><i class="bi bi-funnel-fill icon-small"></i>Filter Grafik</h4>
            <div class="row g-3 align-items-end">
                <div class="col-md-3">
                    <label for="startYear" class="form-label">Tahun Mulai</label>
                    <input type="number" class="form-control" id="startYear" aria-label="Tahun Mulai">
                </div>
                <div class="col-md-3">
                    <label for="endYear" class="form-label">Tahun Selesai</label>
                    <input type="number" class="form-control" id="endYear" aria-label="Tahun Selesai">
                </div>
                <div class="col-md-3">
                    <button class="btn btn-primary w-100" id="applyFilterBtn"><i class="bi bi-search"></i> Terapkan Filter</button>
                </div>
                <div class="col-md-3">
                    <button class="btn btn-outline-secondary w-100" onclick="initializePage()"><i class="bi bi-arrow-clockwise"></i> Reset</button>
                </div>
                <div class="col-12 mt-4">
                    <label class="form-label d-block"><i class="bi bi-building icon-small"></i>Pilih Universitas:</label>
                    <div id="university-filters" class="d-flex flex-wrap gap-2"></div>
                </div>
            </div>
        </div>
        
        <hr>

        <div class="row g-4">
            <div class="col-lg-6">
                <div class="panel" id="summary-panel">
                    <h4 class="mb-4"><i class="bi bi-list-ol icon-small"></i>Peringkat & Ringkasan Data</h4>
                    <div id="summary-table-container">
                        </div>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="panel">
                    <h4 class="chart-title" id="totalChartTitle"><i class="bi bi-bar-chart-fill icon-small"></i>Total Publikasi (dalam Rentang Filter)</h4>
                    <div style="position: relative; height: 50vh;">
                        <canvas id="totalPublicationsChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="panel chart-container">
            <h4 class="chart-title"><i class="bi bi-graph-up icon-small"></i>Publikasi per Tahun</h4>
            <div id="loading-indicator" class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Memuat data...</span>
            </div>
            <canvas id="comparisonChart"></canvas>
        </div>
        
        <hr>
        
        <div class="footer-app-info">
            <h4><i class="bi bi-info-circle-fill"></i> Tentang Aplikasi Ini</h4>
            <p class="mb-1">
                Aplikasi dashboard ini menyajikan perbandingan publikasi ilmiah dari beberapa universitas terkemuka di Indonesia. Data diperoleh secara real-time melalui <strong>OpenAlex API</strong>, sebuah sumber data publikasi akademik yang terbuka dan komprehensif.
            </p>
            <p class="mb-1">
                Anda dapat menggunakan filter tahun untuk memfokuskan analisis pada periode tertentu dan memilih universitas mana saja yang ingin dibandingkan. Grafik batang menampilkan total publikasi dalam rentang tahun yang dipilih, sedangkan grafik garis menunjukkan tren publikasi per tahun.
            </p>
            <p class="text-muted small mt-3">
                <i class="bi bi-database-fill"></i> Data diperbarui: 5 Agustus 2025.
            </p>
        </div>

        <p class="mt-3 text-center text-muted small">&copy; 2025 Dashboard Publikasi. Semua hak cipta dilindungi.</p>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // --- LOGIKA TEMA TERANG/GELAP ---
        const themeToggleBtn = document.getElementById('theme-toggle-btn');
        const themeIcon = document.getElementById('theme-icon');
        const htmlElement = document.documentElement;

        const setTheme = (theme) => {
            htmlElement.setAttribute('data-bs-theme', theme);
            if (theme === 'dark') {
                themeIcon.classList.remove('bi-sun-fill');
                themeIcon.classList.add('bi-moon-fill');
            } else {
                themeIcon.classList.remove('bi-moon-fill');
                themeIcon.classList.add('bi-sun-fill');
            }
        };

        themeToggleBtn.addEventListener('click', () => {
            const currentTheme = htmlElement.getAttribute('data-bs-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            setTheme(newTheme);
            localStorage.setItem('theme', newTheme);
            applyFiltersAndRender(); 
        });

        const savedTheme = localStorage.getItem('theme') || 'light';
        setTheme(savedTheme);

        // --- VARIABEL GLOBAL ---
        let originalData = [];
        let allYears = [];
        let originalTotals = new Map();
        let myLineChartInstance = null;
        let myBarChartInstance = null;

        const chartCanvas = document.getElementById('comparisonChart');
        const totalChartCanvas = document.getElementById('totalPublicationsChart');
        const loadingIndicator = document.getElementById('loading-indicator');

        const universities = [
            { id: 'i205133468', name: 'Airlangga University' },
            { id: 'i29617571', name: 'Universitas Indonesia' },
            { id: 'i177055848', name: 'Universitas Brawijaya' },
            { id: 'i166843116', name: 'Sepuluh Nopember Institute of Technology' },
            { id: 'i165230279', name: 'Universitas Gadjah Mada' },
            { id: 'i134635517', name: 'Bandung Institute of Technology' },
            { id: 'i91819753', name: 'Padjadjaran University' },
            { id: 'i11855966', name: 'Diponegoro University' },
            { id: 'i21881038', name: 'IPB University' },
            { id: 'i119896790', name: 'Sebelas Maret University' },
            { id: 'i862893732', name: 'Telkom University' },
            { id: 'i130218214', name: 'Indonesia University of Education' },
        ];

        const colors = [
            { background: 'rgba(65, 105, 225, 0.8)', border: 'rgba(65, 105, 225, 1)' }, /* Royal Blue */
            { background: 'rgba(255, 206, 86, 0.8)', border: 'rgba(255, 206, 86, 1)' },
            { background: 'rgba(255, 99, 132, 0.8)', border: 'rgba(255, 99, 132, 1)' },
            { background: 'rgba(75, 192, 192, 0.8)', border: 'rgba(75, 192, 192, 1)' },
            { background: 'rgba(153, 102, 255, 0.8)', border: 'rgba(153, 102, 255, 1)' },
            { background: 'rgba(255, 159, 64, 0.8)', border: 'rgba(255, 159, 64, 1)' },
            { background: 'rgba(201, 203, 207, 0.8)', border: 'rgba(201, 203, 207, 1)' },
            { background: 'rgba(0, 123, 255, 0.8)', border: 'rgba(0, 123, 255, 1)' },
            { background: 'rgba(40, 167, 69, 0.8)', border: 'rgba(40, 167, 69, 1)' },
            { background: 'rgba(220, 53, 69, 0.8)', border: 'rgba(220, 53, 69, 1)' },
            { background: 'rgba(23, 162, 184, 0.8)', border: 'rgba(23, 162, 184, 1)' },
            { background: 'rgba(108, 117, 125, 0.8)', border: 'rgba(108, 117, 125, 1)' },
        ];
        
        Chart.register(ChartDataLabels);

        // --- FUNGSI-FUNGSI ---

        async function fetchData(institutionId, universityName) {
            const apiUrl = `https://api.openalex.org/works?group_by=publication_year&per_page=200&filter=authorships.institutions.lineage:${institutionId}`;
            try {
                const response = await fetch(apiUrl);
                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                const data = await response.json();
                return { name: universityName, dataMap: new Map(data.group_by.map(item => [parseInt(item.key_display_name), item.count])) };
            } catch (error) {
                console.error(`Gagal mengambil data untuk ${universityName}:`, error);
                return { name: universityName, dataMap: new Map() };
            }
        }

        function getChartTextColor() {
            const theme = htmlElement.getAttribute('data-bs-theme');
            return theme === 'dark' ? '#f8f9fa' : '#212529';
        }

        function renderLineChart(labels, datasets) {
            if (myLineChartInstance) myLineChartInstance.destroy();
            chartCanvas.style.visibility = 'visible';
            loadingIndicator.style.display = 'none';
            const ctx = chartCanvas.getContext('2d');
            const textColor = getChartTextColor();
            myLineChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels,
                    datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { 
                            beginAtZero: true, 
                            title: { display: true, text: 'Jumlah Publikasi', font: { size: 14, weight: 'bold' }, color: textColor },
                            ticks: { color: textColor, font: { size: 12 } },
                            grid: { color: 'rgba(108, 117, 125, 0.2)' }
                        },
                        x: { 
                            title: { display: true, text: 'Tahun Publikasi', font: { size: 14, weight: 'bold' }, color: textColor },
                            ticks: { color: textColor, font: { size: 12 } },
                            grid: { color: 'rgba(108, 117, 125, 0.2)' }
                        }
                    },
                    plugins: {
                        legend: { position: 'top', labels: { color: textColor } },
                        tooltip: { mode: 'index', intersect: false },
                        datalabels: { 
                            display: false,
                            color: '#444',
                            font: { weight: 'bold' },
                            anchor: 'end',
                            align: 'top',
                            formatter: Math.round
                        }
                    },
                    interaction: { mode: 'index', intersect: false }
                }
            });
        }

        function renderTotalBarChart(labels, datasets) {
            if (myBarChartInstance) myBarChartInstance.destroy();
            const ctx = totalChartCanvas.getContext('2d');
            const textColor = getChartTextColor();
            myBarChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels,
                    datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    scales: {
                        x: { 
                            beginAtZero: true, 
                            title: { display: true, text: 'Total Publikasi', font: { size: 14, weight: 'bold' }, color: textColor },
                            ticks: { color: textColor, font: { size: 12 } },
                            grid: { color: 'rgba(108, 117, 125, 0.2)' }
                        },
                        y: {
                            ticks: {
                                font: { size: 12, color: textColor }
                            },
                            grid: { color: 'rgba(108, 117, 125, 0.2)' }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        datalabels: {
                            color: '#fff',
                            font: { weight: 'bold', size: 12 },
                            anchor: 'center',
                            align: 'center',
                            formatter: value => value.toLocaleString('id-ID')
                        }
                    }
                }
            });
        }

        function updateSummaryPanel(filteredTotals) {
            const container = document.getElementById('summary-table-container');

            let rankedData = Array.from(filteredTotals.keys()).map(name => ({
                name: name,
                totalOriginal: originalTotals.get(name) || 0,
                totalFiltered: filteredTotals.get(name) || 0
            }));
            
            rankedData.sort((a, b) => b.totalFiltered - a.totalFiltered);

            let tableHTML = `<div class="table-responsive"><table class="table table-hover table-sm">
                                <thead>
                                    <tr>
                                        <th style="width: 5%;">No.</th>
                                        <th>Universitas</th>
                                        <th>Total (Semua Tahun)</th>
                                        <th>Total (Difilter)</th>
                                    </tr>
                                </thead>
                                <tbody>`;

            rankedData.forEach((uniData, index) => {
                tableHTML += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${uniData.name}</td>
                        <td>${uniData.totalOriginal.toLocaleString('id-ID')}</td>
                        <td><b>${uniData.totalFiltered.toLocaleString('id-ID')}</b></td>
                    </tr>
                `;
            });

            tableHTML += '</tbody></table></div>';
            container.innerHTML = tableHTML;
        }

        function applyFiltersAndRender() {
            const startYearInput = document.getElementById('startYear').value;
            const endYearInput = document.getElementById('endYear').value;
            
            const defaultStartYear = 2020;
            const defaultEndYear = 2025;

            const startYear = startYearInput ? parseInt(startYearInput) : defaultStartYear;
            const endYear = endYearInput ? parseInt(endYearInput) : defaultEndYear;

            const totalChartTitle = document.getElementById('totalChartTitle');
            if (totalChartTitle) {
                totalChartTitle.innerHTML = `<i class="bi bi-bar-chart-fill icon-small"></i>Total Publikasi (${startYear} - ${endYear})`;
            }

            const selectedUniversities = new Set();
            document.querySelectorAll('#university-filters input:checked').forEach(input => selectedUniversities.add(input.value));
            
            if (selectedUniversities.size === 0) {
                 alert('Pilih setidaknya satu universitas.');
                 return;
            }

            const filteredYears = allYears.filter(year => year >= startYear && year <= endYear);

            const filteredDatasetsLine = [];
            const filteredTotals = new Map();

            originalData.forEach(uniData => {
                if (selectedUniversities.has(uniData.name)) {
                    const totalFiltered = filteredYears.reduce((sum, year) => sum + (uniData.dataMap.get(year) || 0), 0);
                    filteredTotals.set(uniData.name, totalFiltered);

                    const dataForChart = filteredYears.map(year => uniData.dataMap.get(year) || 0);
                    const colorIndex = universities.findIndex(u => u.name === uniData.name);
                    if (colorIndex !== -1) {
                         filteredDatasetsLine.push({
                            label: uniData.name,
                            data: dataForChart,
                            backgroundColor: colors[colorIndex].border,
                            borderColor: colors[colorIndex].border,
                            borderWidth: 3,
                            fill: false,
                            tension: 0.4
                        });
                    }
                }
            });

            const barChartLabels = Array.from(filteredTotals.keys()).sort((a,b) => filteredTotals.get(b) - filteredTotals.get(a));
            const barChartData = barChartLabels.map(label => filteredTotals.get(label));
            const barChartColors = barChartLabels.map(label => colors[universities.findIndex(u => u.name === label)].background);

            const filteredDatasetsBar = [{
                label: 'Total Publikasi',
                data: barChartData,
                backgroundColor: barChartColors,
                borderColor: barChartColors.map(c => c.replace('0.8', '1')),
                borderWidth: 1
            }];

            renderLineChart(filteredYears, filteredDatasetsLine);
            renderTotalBarChart(barChartLabels, filteredDatasetsBar);
            updateSummaryPanel(filteredTotals);
        }

        async function initializePage() {
            chartCanvas.style.visibility = 'hidden';
            loadingIndicator.style.display = 'block';

            const uniFilterContainer = document.getElementById('university-filters');
            uniFilterContainer.innerHTML = '';
            universities.forEach(uni => {
                uniFilterContainer.innerHTML += `<div class="form-check form-check-inline"><input class="form-check-input" type="checkbox" value="${uni.name}" id="check-${uni.id}" checked><label class="form-check-label" for="check-${uni.id}">${uni.name}</label></div>`;
            });

            originalData = await Promise.all(universities.map(uni => fetchData(uni.id, uni.name)));

            const yearsSet = new Set();
            originalData.forEach(result => {
                let total = 0;
                result.dataMap.forEach((count, year) => {
                    yearsSet.add(year);
                    total += count;
                });
                originalTotals.set(result.name, total);
            });
            allYears = Array.from(yearsSet).sort((a, b) => a - b);

            // Perubahan di sini: Mengatur nilai default ke 2020 dan 2025
            const defaultStartYear = 2020;
            const defaultEndYear = 2025;

            document.getElementById('startYear').placeholder = defaultStartYear;
            document.getElementById('startYear').value = defaultStartYear;
            document.getElementById('endYear').placeholder = defaultEndYear;
            document.getElementById('endYear').value = defaultEndYear;

            document.getElementById('applyFilterBtn').addEventListener('click', applyFiltersAndRender);
            
            document.querySelectorAll('#university-filters input[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('change', applyFiltersAndRender);
            });
            
            applyFiltersAndRender();
        }

        document.addEventListener('DOMContentLoaded', initializePage);
    </script>
</body>
</html>